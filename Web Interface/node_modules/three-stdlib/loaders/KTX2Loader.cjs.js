"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),r=require("./BasisTextureLoader.cjs.js"),t=require("zstddec"),s=require("ktx-parse");class a extends e.CompressedTextureLoader{constructor(e){super(e),this.basisLoader=new r.BasisTextureLoader(e),this.zstd=new t.ZSTDDecoder,this.zstd.init(),"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.basisLoader.setTranscoderPath(e),this}setWorkerLimit(e){return this.basisLoader.setWorkerLimit(e),this}detectSupport(e){return this.basisLoader.detectSupport(e),this}dispose(){return this.basisLoader.dispose(),this}load(r,t,s,a){var o=this,n=new e.CompressedTexture;return new Promise((function(t,a){new e.FileLoader(o.manager).setPath(o.path).setResponseType("arraybuffer").load(r,t,s,a)})).then((function(e){o.parse(e,(function(e){n.copy(e),n.needsUpdate=!0,t&&t(n)}),a)})).catch(a),n}parse(t,a,n){var i=this,l=s.read(new Uint8Array(t));if(l.pixelDepth>0)throw new Error("THREE.KTX2Loader: Only 2D textures are currently supported.");if(l.layerCount>1)throw new Error("THREE.KTX2Loader: Array textures are not currently supported.");if(l.faceCount>1)throw new Error("THREE.KTX2Loader: Cube textures are not currently supported.");var h=o.getBasicDFD(l);return o.createLevels(l,this.zstd).then((function(e){var t=h.colorModel===s.KTX2Model.UASTC?r.BasisTextureLoader.BasisFormat.UASTC_4x4:r.BasisTextureLoader.BasisFormat.ETC1S,a={levels:e,width:l.pixelWidth,height:l.pixelHeight,basisFormat:t,hasAlpha:o.getAlpha(l)};return t===r.BasisTextureLoader.BasisFormat.ETC1S&&(a.globalData=l.globalData),i.basisLoader.parseInternalAsync(a)})).then((function(r){r.encoding=h.transferFunction===s.KTX2Transfer.SRGB?e.sRGBEncoding:e.LinearEncoding,r.premultiplyAlpha=o.getPremultiplyAlpha(l),a(r)})).catch(n),this}}var o={createLevels:async function(e,r){e.supercompressionScheme===s.KTX2SupercompressionScheme.ZSTD&&await r.init();for(var t=[],a=e.pixelWidth,o=e.pixelHeight,n=0;n<e.levels.length;n++){var i=Math.max(1,Math.floor(a/Math.pow(2,n))),l=Math.max(1,Math.floor(o/Math.pow(2,n))),h=e.levels[n].levelData;e.supercompressionScheme===s.KTX2SupercompressionScheme.ZSTD&&(h=r.decode(h,e.levels[n].uncompressedByteLength)),t.push({index:n,width:i,height:l,data:h})}return t},getBasicDFD:function(e){return e.dataFormatDescriptor[0]},getAlpha:function(e){var r=this.getBasicDFD(e);return r.colorModel===s.KTX2Model.UASTC?(15&r.samples[0].channelID)===s.KTX2ChannelUASTC.RGBA:2===r.samples.length&&(15&r.samples[1].channelID)===s.KTX2ChannelETC1S.AAA},getPremultiplyAlpha:function(e){return!!(this.getBasicDFD(e).flags&s.KTX2Flags.ALPHA_PREMULTIPLIED)}};exports.KTX2Loader=a;
